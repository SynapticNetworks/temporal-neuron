# STDP Testing Guide

This document explains how to properly test Spike-Timing-Dependent Plasticity (STDP) in the temporal neuron system.

## STDP Background

STDP is a biological learning mechanism where synaptic weight changes depend on the relative timing between pre-synaptic and post-synaptic spikes:

- **LTP (Long-Term Potentiation)**: When a pre-synaptic spike occurs before a post-synaptic spike (negative deltaT), the connection strengthens
- **LTD (Long-Term Depression)**: When a post-synaptic spike occurs before a pre-synaptic spike (positive deltaT), the connection weakens

## Testing STDP Correctly

To properly test STDP, two critical elements must be present:

1. **Pre-synaptic spikes**: Must be explicitly recorded on the synapse with the correct timing
2. **Post-synaptic spikes**: Must be generated by making the neuron fire

### Key Testing Steps

1. **Setup**: Create a neuron and enable STDP
   ```go
   neuron := NewNeuron("test_neuron", ...)
   neuron.EnableSTDPFeedback(10*time.Millisecond, 0.1)
   
   // Verify STDP is enabled
   if !neuron.IsSTDPFeedbackEnabled() {
       t.Fatalf("STDP should be enabled but isn't")
   }
   ```

2. **Record pre-spikes**: For each test synapse, get the synapse object and record a pre-spike with the desired timing
   ```go
   // Get the mock synapse
   synObj, err := mockCallbacks.GetSynapse("test_synapse")
   if err == nil {
       // Record pre-spike with appropriate timing
       if recorder, ok := synObj.(interface{ RecordPreSpike(time.Time) }); ok {
           preTime := time.Now().Add(-5 * time.Millisecond) // For LTP
           recorder.RecordPreSpike(preTime)
       }
   }
   ```

3. **Trigger neuron firing**: Use `SendTestSignal()` to make the neuron fire naturally
   ```go
   // Trigger neuron firing to create post-spike
   SendTestSignal(neuron, "test_trigger", 2.0) // Strong signal to ensure firing
   ```

4. **Wait for STDP processing**: Allow time for firing and STDP to complete
   ```go
   // Wait for STDP processing (firing + feedback delay + processing)
   time.Sleep(50 * time.Millisecond)
   ```

5. **Analyze results**: Check for plasticity adjustments
   ```go
   // Check adjustment properties
   adjustments := mockMatrix.GetPlasticityAdjustments()
   if len(adjustments) == 0 {
       t.Error("Expected STDP to generate plasticity adjustments")
   } else {
       adjustment := adjustments[0]
       t.Logf("STDP adjustment: DeltaT=%v, LearningRate=%.3f", adjustment.DeltaT, adjustment.LearningRate)
   }
   ```

### Common Mistakes

1. ❌ **Calling `SendSTDPFeedback()` directly**: This bypasses the natural STDP pathway and can lead to errors
   ```go
   // DON'T DO THIS in tests
   neuron.SendSTDPFeedback() // Incorrect approach
   ```

2. ❌ **Not recording pre-spikes**: Simply setting `LastActivity` without recording spikes won't work
   ```go
   // DON'T RELY ON THIS ALONE
   synapseInfo.LastActivity = time.Now().Add(-5 * time.Millisecond)
   ```

3. ❌ **Not verifying STDP enablement**: Make sure STDP is actually enabled before testing
   ```go
   // ALWAYS DO THIS
   if !neuron.IsSTDPFeedbackEnabled() {
       t.Fatalf("STDP not properly enabled")
   }
   ```

## STDP Testing Patterns

### Testing LTP (Pre-before-Post)

```go
// Record pre-spike 5ms before current time
preTime := time.Now().Add(-5 * time.Millisecond)
recorder.RecordPreSpike(preTime)

// Trigger neuron firing now (post-spike)
SendTestSignal(neuron, "test", 2.0)

// Expected result: DeltaT is negative, weight increases
```

### Testing LTD (Post-before-Pre)

```go
// Record pre-spike 5ms after current time
preTime := time.Now().Add(5 * time.Millisecond)
recorder.RecordPreSpike(preTime)

// Trigger neuron firing now (post-spike)
SendTestSignal(neuron, "test", 2.0)

// Expected result: DeltaT is positive, weight decreases
```

## Best Practices

1. **Use natural firing**: Always trigger neuron firing naturally rather than calling STDP methods directly
2. **Explicit pre-spikes**: Always explicitly record pre-spikes on synapses
3. **Verify enablement**: Always check that STDP is properly enabled
4. **Wait properly**: Allow sufficient time for STDP processing to complete
5. **Detailed logging**: Log spike times and STDP adjustments for easier debugging

By following these guidelines, you can ensure reliable and accurate testing of STDP behavior.